apiVersion: v1
kind: ConfigMap
metadata:
  name: payflow-db-migrations
  namespace: payflow
data:
  V1__initial_schema.sql: |
    CREATE TABLE IF NOT EXISTS users (
      id VARCHAR(50) PRIMARY KEY,
      email VARCHAR(255) UNIQUE NOT NULL,
      password_hash VARCHAR(255) NOT NULL,
      name VARCHAR(100) NOT NULL,
      role VARCHAR(20) DEFAULT 'user',
      is_active BOOLEAN DEFAULT true,
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
      updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    CREATE TABLE IF NOT EXISTS wallets (
      user_id VARCHAR(50) PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
      name VARCHAR(100) NOT NULL,
      balance DECIMAL(15,2) NOT NULL DEFAULT 0.00,
      currency VARCHAR(3) DEFAULT 'USD',
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
      updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    CREATE TABLE IF NOT EXISTS transactions (
      id VARCHAR(50) PRIMARY KEY,
      from_user_id VARCHAR(50) NOT NULL,
      to_user_id VARCHAR(50) NOT NULL,
      amount DECIMAL(15,2) NOT NULL,
      status VARCHAR(20) NOT NULL,
      error_message TEXT,
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
      processing_started_at TIMESTAMP,
      completed_at TIMESTAMP,
      CONSTRAINT fk_from_user FOREIGN KEY (from_user_id) REFERENCES users(id),
      CONSTRAINT fk_to_user FOREIGN KEY (to_user_id) REFERENCES users(id)
    );

    CREATE TABLE IF NOT EXISTS notifications (
      id SERIAL PRIMARY KEY,
      user_id VARCHAR(50) NOT NULL REFERENCES users(id) ON DELETE CASCADE,
      type VARCHAR(50) NOT NULL,
      message TEXT NOT NULL,
      transaction_id VARCHAR(50),
      read BOOLEAN DEFAULT FALSE,
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    CREATE TABLE IF NOT EXISTS audit_logs (
      id SERIAL PRIMARY KEY,
      user_id VARCHAR(50),
      action VARCHAR(100) NOT NULL,
      resource VARCHAR(100),
      ip_address VARCHAR(45),
      user_agent TEXT,
      metadata JSONB,
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
  V2__add_indexes.sql: |
    CREATE INDEX idx_users_email ON users(email);
    CREATE INDEX idx_wallets_user ON wallets(user_id);
    CREATE INDEX idx_transactions_from_user ON transactions(from_user_id, created_at DESC);
    CREATE INDEX idx_transactions_to_user ON transactions(to_user_id, created_at DESC);
    CREATE INDEX idx_transactions_status ON transactions(status) WHERE status IN ('PENDING', 'PROCESSING');
    CREATE INDEX idx_notifications_user ON notifications(user_id, created_at DESC);
    CREATE INDEX idx_audit_logs_user ON audit_logs(user_id, created_at DESC);
    CREATE INDEX idx_audit_logs_action ON audit_logs(action, created_at DESC);
  V3__add_2fa.sql: |
    ALTER TABLE users ADD COLUMN IF NOT EXISTS two_factor_enabled BOOLEAN DEFAULT false;
    ALTER TABLE users ADD COLUMN IF NOT EXISTS two_factor_secret VARCHAR(255);
    ALTER TABLE users ADD COLUMN IF NOT EXISTS email_verified BOOLEAN DEFAULT false;
    ALTER TABLE users ADD COLUMN IF NOT EXISTS failed_login_attempts INT DEFAULT 0;
    ALTER TABLE users ADD COLUMN IF NOT EXISTS locked_until TIMESTAMP;
    ALTER TABLE users ADD COLUMN IF NOT EXISTS last_login_at TIMESTAMP;
    ALTER TABLE users ADD COLUMN IF NOT EXISTS last_login_ip VARCHAR(45);
